<!--http://weblogs.asp.net/dwahlin/using-an-angularjs-factory-to-interact-with-a-restful-service-->

<!--Because the functions defined in the factory don’t know what to do with the data they handle,
each one returns a promise that can be wired up to callback functions by the caller.-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>

<!-- using factory-->
<script>
    angular.module('customersApp')
            .factory('dataFactory', ['$http', function($http) {

                var urlBase = '/api/customers';
                var dataFactory = {};

                dataFactory.getCustomers = function () {
                    return $http.get(urlBase);
                };

                dataFactory.getCustomer = function (id) {
                    return $http.get(urlBase + '/' + id);
                };

                dataFactory.insertCustomer = function (cust) {
                    return $http.post(urlBase, cust);
                };

                dataFactory.updateCustomer = function (cust) {
                    return $http.put(urlBase + '/' + cust.ID, cust)
                };

                dataFactory.deleteCustomer = function (id) {
                    return $http.delete(urlBase + '/' + id);
                };

                dataFactory.getOrders = function (id) {
                    return $http.get(urlBase + '/' + id + '/orders');
                };

                return dataFactory;
            }]);
</script>

<!--using service -->
<script>

    angular.module('customersApp')
            .service('dataService', ['$http', function ($http) {

                var urlBase = '/api/customers';

                this.getCustomers = function () {
                    return $http.get(urlBase);
                };

                this.getCustomer = function (id) {
                    return $http.get(urlBase + '/' + id);
                };

                this.insertCustomer = function (cust) {
                    return $http.post(urlBase, cust);
                };

                this.updateCustomer = function (cust) {
                    return $http.put(urlBase + '/' + cust.ID, cust)
                };

                this.deleteCustomer = function (id) {
                    return $http.delete(urlBase + '/' + id);
                };

                this.getOrders = function (id) {
                    return $http.get(urlBase + '/' + id + '/orders');
                };
            }]);
</script>



<!--using factory function -->
<script>

    angular.module('customersApp')
            .controller('customersController', ['$scope', 'dataFactory',
                function ($scope, dataFactory) {

                    $scope.status;
                    $scope.customers;
                    $scope.orders;

                    getCustomers();

                    function getCustomers() {
                        dataFactory.getCustomers()
                                .success(function (custs) {
                                    $scope.customers = custs;
                                })
                                .error(function (error) {
                                    $scope.status = 'Unable to load customer data: ' + error.message;
                                });
                    }

                    /*he downside of blindly passing your $http.get promise back to the controller is that the
                    controller has to deal with the result itself. What if you want the service to post-process the result instead? More importantly,
                    what if you want to deal with the $http errors in the service layer,
                    so that the controller doesn't need to handle redirects, 404s, etc?*/
                    $scope.updateCustomer = function (id) {
                        var cust;
                        for (var i = 0; i < $scope.customers.length; i++) {
                            var currCust = $scope.customers[i];
                            if (currCust.ID === id) {
                                cust = currCust;
                                break;
                            }
                        }

                        dataFactory.updateCustomer(cust)
                                .success(function () {
                                    $scope.status = 'Updated Customer! Refreshing customer list.';
                                })
                                .error(function (error) {
                                    $scope.status = 'Unable to update customer: ' + error.message;
                                });
                    };

                    $scope.insertCustomer = function () {
                        //Fake customer data
                        var cust = {
                            ID: 10,
                            FirstName: 'JoJo',
                            LastName: 'Pikidily'
                        };
                        dataFactory.insertCustomer(cust)
                                .success(function () {
                                    $scope.status = 'Inserted Customer! Refreshing customer list.';
                                    $scope.customers.push(cust);
                                }).
                                error(function(error) {
                                    $scope.status = 'Unable to insert customer: ' + error.message;
                                });
                    };

                    $scope.deleteCustomer = function (id) {
                        dataFactory.deleteCustomer(id)
                                .success(function () {
                                    $scope.status = 'Deleted Customer! Refreshing customer list.';
                                    for (var i = 0; i < $scope.customers.length; i++) {
                                        var cust = $scope.customers[i];
                                        if (cust.ID === id) {
                                            $scope.customers.splice(i, 1);
                                            break;
                                        }
                                    }
                                    $scope.orders = null;
                                })
                                .error(function (error) {
                                    $scope.status = 'Unable to delete customer: ' + error.message;
                                });
                    };

                    $scope.getCustomerOrders = function (id) {
                        dataFactory.getOrders(id)
                                .success(function (orders) {
                                    $scope.status = 'Retrieved orders!';
                                    $scope.orders = orders;
                                })
                                .error(function (error) {
                                    $scope.status = 'Error retrieving customers! ' + error.message;
                                });
                    };
                }]);
</script>
</body>
</html>

<!--Although AngularJS controllers can call directly into back-end services,
I prefer to put that type of functionality into factories so that it’s more re-useable and easier to maintain.
The application discussed here relies on a factory named dataFactory to make calls into the ASP.NET Web API service.-->